name: Docker Image CI

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]
env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: zicops-one    # TODO: update to cluster name
  GKE_ZONE: asia-southeast1-a   # TODO: update to cluster zone
  SERVICE_NAME: zicops-course-creator
jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Auth GCP service account
      uses: 'google-github-actions/auth@v0'
      with:
        credentials_json: ${{ secrets.GCR_DEVOPS_SERVICE_ACCOUNT_KEY }}
 # Build docker image
    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v0'
    - name: 'Use gcloud CLI'
      run: 'gcloud info'
    - name: Build the Docker image
      run: |-
        docker build -t gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA --build-arg GO_MODULES_TOKEN=${{secrets.GO_MODULES_TOKEN}} .
    - name: add latest tag
      run: |-
        docker tag gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA gcr.io/$PROJECT_ID/$SERVICE_NAME:latest    
    - run: |
        gcloud auth configure-docker -q
    - name: Push image to GCP
      run: docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA
    - name: Push image to GCP
      run: docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:latest
    - name: replace environment variable in values.yaml
      run:  envsubst '${GITHUB_SHA}' < k8s/zicops-course-creator/values.template.yaml >  k8s/zicops-course-creator/values.yaml
    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
    - name: Deploy to zicops-one
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER \
          --zone $GKE_ZONE \
          --project $PROJECT_ID
        helm upgrade zicops-course-creator k8s/zicops-course-creator --install --wait --atomic